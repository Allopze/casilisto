import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, Trash2, Check, RotateCcw, Minus, Utensils, Carrot, Milk, Beef, 
  Home, Coffee, Croissant, ShoppingCart, PiggyBank, Cat, X, GripVertical, 
  ChevronDown, ChevronUp, Edit3, Menu, Settings, Tag, Download, Upload, AlertTriangle
} from 'lucide-react';

// --- ESTILOS PERSONALIZADOS (CSS INLINE) ---
const StyleTag = () => (
  <style>{`
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scroll-mask {
      mask-image: linear-gradient(to right, black 85%, transparent 100%);
      -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
    }
  `}</style>
);

// --- DATOS POR DEFECTO ---
const DEFAULT_CATEGORIES = {
  'Frutas y Verduras': { color: 'bg-green-100 text-green-800', border: 'border-green-200', iconName: 'Carrot' },
  'Carnes y Pescados': { color: 'bg-red-100 text-red-800', border: 'border-red-200', iconName: 'Beef' },
  'Lácteos y Huevos': { color: 'bg-blue-100 text-blue-800', border: 'border-blue-200', iconName: 'Milk' },
  'Despensa': { color: 'bg-orange-100 text-orange-800', border: 'border-orange-200', iconName: 'Utensils' },
  'Panadería y Dulces': { color: 'bg-yellow-200 text-yellow-800', border: 'border-yellow-300', iconName: 'Croissant' },
  'Bebidas': { color: 'bg-purple-100 text-purple-800', border: 'border-purple-200', iconName: 'Coffee' },
  'Hogar y Limpieza': { color: 'bg-stone-200 text-stone-800', border: 'border-stone-300', iconName: 'Home' },
  'Mascotas': { color: 'bg-amber-100 text-amber-800', border: 'border-amber-200', iconName: 'Cat' },
  'Otros': { color: 'bg-gray-100 text-gray-800', border: 'border-gray-200', iconName: 'ShoppingCart' },
};

const DEFAULT_MASTER_LIST = [
  { name: 'Pan', category: 'Panadería y Dulces' },
  { name: 'Pan de cebolla', category: 'Panadería y Dulces' },
  { name: 'Pan Perfecto', category: 'Panadería y Dulces' },
  { name: 'Pan Bimbo', category: 'Panadería y Dulces' },
  { name: 'Pan tostado', category: 'Panadería y Dulces' },
  { name: 'Pan de ajo', category: 'Panadería y Dulces' },
  { name: 'Colaciones', category: 'Panadería y Dulces' },
  { name: 'Doritos', category: 'Panadería y Dulces' },
  { name: 'Chocolate', category: 'Panadería y Dulces' },
  { name: 'Comida seca Gatos', category: 'Mascotas' },
  { name: 'Comida húmeda Gatos', category: 'Mascotas' },
  { name: 'Queso Laminado', category: 'Lácteos y Huevos' },
  { name: 'Queso', category: 'Lácteos y Huevos' },
  { name: 'Queso La Vaquita', category: 'Lácteos y Huevos' },
  { name: 'Margarina', category: 'Lácteos y Huevos' },
  { name: 'Leche sin lactosa', category: 'Lácteos y Huevos' },
  { name: 'Leche semi', category: 'Lácteos y Huevos' },
  { name: 'Yogures', category: 'Lácteos y Huevos' },
  { name: 'Huevos', category: 'Lácteos y Huevos' },
  { name: 'Queso rallado', category: 'Lácteos y Huevos' },
  { name: 'Cebollas', category: 'Frutas y Verduras' },
  { name: 'Ajos', category: 'Frutas y Verduras' },
  { name: 'Manzanas', category: 'Frutas y Verduras' },
  { name: 'Plátanos', category: 'Frutas y Verduras' },
  { name: 'Mandarinas', category: 'Frutas y Verduras' },
  { name: 'Tomates', category: 'Frutas y Verduras' },
  { name: 'Zapallo', category: 'Frutas y Verduras' },
  { name: 'Palta', category: 'Frutas y Verduras' },
  { name: 'Mangos', category: 'Frutas y Verduras' },
  { name: 'Limones', category: 'Frutas y Verduras' },
  { name: 'Zanahorias', category: 'Frutas y Verduras' },
  { name: 'Lechuga', category: 'Frutas y Verduras' },
  { name: 'Pimiento rojo', category: 'Frutas y Verduras' },
  { name: 'Pimiento verde', category: 'Frutas y Verduras' },
  { name: 'Setas', category: 'Frutas y Verduras' },
  { name: 'Champiñones frescos', category: 'Frutas y Verduras' },
  { name: 'Patatas', category: 'Frutas y Verduras' },
  { name: 'Jugos', category: 'Bebidas' },
  { name: 'Coca cola', category: 'Bebidas' },
  { name: 'Orange', category: 'Bebidas' },
  { name: 'Cerveza', category: 'Bebidas' },
  { name: 'Vino', category: 'Bebidas' },
  { name: 'Café', category: 'Bebidas' },
  { name: 'Colacao', category: 'Bebidas' },
  { name: 'Jamon Colonial', category: 'Carnes y Pescados' },
  { name: 'Jamón de pavo', category: 'Carnes y Pescados' },
  { name: 'Tocino', category: 'Carnes y Pescados' },
  { name: 'Chorizo bocata', category: 'Carnes y Pescados' },
  { name: 'Chorizo cocinar', category: 'Carnes y Pescados' },
  { name: 'Jamón serrano', category: 'Carnes y Pescados' },
  { name: 'Taco de jamón', category: 'Carnes y Pescados' },
  { name: 'Pollo', category: 'Carnes y Pescados' },
  { name: 'Trutos de Pollo', category: 'Carnes y Pescados' },
  { name: 'Pechugas de pollo', category: 'Carnes y Pescados' },
  { name: 'Asiento', category: 'Carnes y Pescados' },
  { name: 'Costilla de cerdo', category: 'Carnes y Pescados' },
  { name: 'Chuletas de cerdo', category: 'Carnes y Pescados' },
  { name: 'Lomo de cerdo', category: 'Carnes y Pescados' },
  { name: 'Carne', category: 'Carnes y Pescados' },
  { name: 'Huesos carnudo', category: 'Carnes y Pescados' },
  { name: 'Carne molida', category: 'Carnes y Pescados' },
  { name: 'Pescado', category: 'Carnes y Pescados' },
  { name: 'Merluza', category: 'Carnes y Pescados' },
  { name: 'Salmón', category: 'Carnes y Pescados' },
  { name: 'Camarones', category: 'Carnes y Pescados' },
  { name: 'Pulpo', category: 'Carnes y Pescados' },
  { name: 'Calamares', category: 'Carnes y Pescados' },
  { name: 'Rabas', category: 'Carnes y Pescados' },
  { name: 'Jibia', category: 'Carnes y Pescados' },
  { name: 'Mejillones', category: 'Carnes y Pescados' },
  { name: 'Aceite girasol', category: 'Despensa' },
  { name: 'Aceite de oliva', category: 'Despensa' },
  { name: 'Vinagre', category: 'Despensa' },
  { name: 'Vinagre blanco Carbonel', category: 'Despensa' },
  { name: 'Vinagre de jerez Carbonel', category: 'Despensa' },
  { name: 'Vinagre de arroz', category: 'Despensa' },
  { name: 'Salsa de soja', category: 'Despensa' },
  { name: 'Mayonesa', category: 'Despensa' },
  { name: 'Mayonesa con ajo', category: 'Despensa' },
  { name: 'Sal', category: 'Despensa' },
  { name: 'Pote de sal', category: 'Despensa' },
  { name: 'Arroz', category: 'Despensa' },
  { name: 'Macarrones', category: 'Despensa' },
  { name: 'Espagueti', category: 'Despensa' },
  { name: 'Fideos', category: 'Despensa' },
  { name: 'Sopas', category: 'Despensa' },
  { name: 'Caldo de pollo', category: 'Despensa' },
  { name: 'Caldo de carne', category: 'Despensa' },
  { name: 'Lentejas', category: 'Despensa' },
  { name: 'Alubias', category: 'Despensa' },
  { name: 'Garbanzos', category: 'Despensa' },
  { name: 'Mejillones escabeche', category: 'Despensa' },
  { name: 'Sardinas', category: 'Despensa' },
  { name: 'Atún', category: 'Despensa' },
  { name: 'Aceitunas', category: 'Despensa' },
  { name: 'Paté', category: 'Despensa' },
  { name: 'Guisantes', category: 'Despensa' },
  { name: 'Pimiento morrón', category: 'Despensa' },
  { name: 'Champiñones', category: 'Despensa' },
  { name: 'Tuco', category: 'Despensa' },
  { name: 'Salsa de tomate', category: 'Despensa' },
  { name: 'Kepchup', category: 'Despensa' },
  { name: 'Pollo crispi', category: 'Despensa' },
  { name: 'Sopas de pollo', category: 'Despensa' },
  { name: 'Harina de maíz', category: 'Despensa' },
  { name: 'Harina de trigo', category: 'Despensa' },
  { name: 'Pasta lasaña', category: 'Despensa' },
  { name: 'Carbón', category: 'Hogar y Limpieza' },
  { name: 'Cloro normal', category: 'Hogar y Limpieza' },
  { name: 'Cloro color', category: 'Hogar y Limpieza' },
  { name: 'Detergente', category: 'Hogar y Limpieza' },
  { name: 'Ambientador automático', category: 'Hogar y Limpieza' },
  { name: 'Ambientador', category: 'Hogar y Limpieza' },
  { name: 'Limpiasuelo', category: 'Hogar y Limpieza' },
  { name: 'Lavavajillas', category: 'Hogar y Limpieza' },
  { name: 'Bolsas basura grandes', category: 'Hogar y Limpieza' },
  { name: 'Bolsas basura pequeñas', category: 'Hogar y Limpieza' },
  { name: 'Jabón líquido Dove', category: 'Hogar y Limpieza' },
  { name: 'Jabón pastilla Dove', category: 'Hogar y Limpieza' },
  { name: 'Pasta de dientes', category: 'Hogar y Limpieza' },
  { name: 'Desodorante', category: 'Hogar y Limpieza' },
  { name: 'Champú', category: 'Hogar y Limpieza' },
  { name: 'Hisopos', category: 'Hogar y Limpieza' },
  { name: 'Maquinilla de afeitar', category: 'Hogar y Limpieza' },
  { name: 'Papel higiénico', category: 'Hogar y Limpieza' },
  { name: 'Servilletas', category: 'Hogar y Limpieza' },
  { name: 'Papel de cocina', category: 'Hogar y Limpieza' },
  { name: 'Pañuelos', category: 'Hogar y Limpieza' },
];

const ICON_MAP = {
  Carrot, Beef, Milk, Utensils, Croissant, Coffee, Home, Cat, ShoppingCart, Tag
};

const COLOR_PRESETS = [
  { name: 'Verde', bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-200' },
  { name: 'Rojo', bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200' },
  { name: 'Azul', bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200' },
  { name: 'Naranja', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200' },
  { name: 'Amarillo', bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
  { name: 'Morado', bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200' },
  { name: 'Gris', bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-200' },
  { name: 'Rosa', bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-200' },
  { name: 'Turquesa', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200' },
];

export default function App() {
  const [categories, setCategories] = useState(() => {
    const saved = localStorage.getItem('shoppingListCategories');
    return saved ? JSON.parse(saved) : DEFAULT_CATEGORIES;
  });

  const [masterList, setMasterList] = useState(() => {
    const saved = localStorage.getItem('shoppingListMaster');
    return saved ? JSON.parse(saved) : DEFAULT_MASTER_LIST;
  });

  const [items, setItems] = useState(() => {
    const savedItems = localStorage.getItem('shoppingListV5');
    if (savedItems) return JSON.parse(savedItems);
    return [
      { id: 1, text: 'Leche', completed: false, category: 'Lácteos y Huevos', quantity: 1 },
      { id: 2, text: 'Pan', completed: false, category: 'Panadería y Dulces', quantity: 1 },
    ];
  });

  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [expandedItemId, setExpandedItemId] = useState(null);
  const [newItemText, setNewItemText] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('Otros');
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  
  const [expandedSettingsCat, setExpandedSettingsCat] = useState(null);
  const [newCatName, setNewCatName] = useState('');
  const [newCatColor, setNewCatColor] = useState(COLOR_PRESETS[0]);
  const [newMasterItemText, setNewMasterItemText] = useState('');

  const [draggingId, setDraggingId] = useState(null);
  const [dragOverlay, setDragOverlay] = useState(null);
  
  const wrapperRef = useRef(null);
  const dragItem = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => { localStorage.setItem('shoppingListV5', JSON.stringify(items)); }, [items]);
  useEffect(() => { localStorage.setItem('shoppingListCategories', JSON.stringify(categories)); }, [categories]);
  useEffect(() => { localStorage.setItem('shoppingListMaster', JSON.stringify(masterList)); }, [masterList]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setShowSuggestions(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [wrapperRef]);

  // --- BACKUP FUNCTIONS ---
  const handleExport = () => {
    const data = {
      items,
      categories,
      masterList,
      timestamp: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CasiListo_Copia_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleImportClick = () => {
    fileInputRef.current.click();
  };

  const handleImportFile = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (window.confirm('¿Estás seguro? Esto reemplazará tu lista actual por la copia de seguridad.')) {
          if (data.items) setItems(data.items);
          if (data.categories) setCategories(data.categories);
          if (data.masterList) setMasterList(data.masterList);
          alert('¡Copia restaurada con éxito!');
          setIsMenuOpen(false);
        }
      } catch (error) {
        alert('Error al leer el archivo. Asegúrate de que es una copia válida de CasiListo.');
      }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset input
  };

  // --- MAIN LOGIC ---

  const addItem = (e) => {
    e.preventDefault();
    if (!newItemText.trim()) return;

    const existingItemIndex = items.findIndex(
      i => i.text.toLowerCase() === newItemText.trim().toLowerCase() && i.completed === false
    );

    if (existingItemIndex > -1) {
      const newItems = [...items];
      newItems[existingItemIndex].quantity += 1;
      setItems(newItems);
    } else {
      const newItem = {
        id: Date.now(),
        text: newItemText.trim(),
        completed: false,
        category: selectedCategory,
        quantity: 1
      };
      setItems([...items, newItem]);
    }
    setNewItemText('');
    setSelectedCategory('Otros');
    setShowSuggestions(false);
  };

  const toggleItem = (id) => {
    setItems(items.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
  };

  const updateQuantity = (id, delta) => {
    setItems(items.map(item => {
      if (item.id === id) {
        const newQuantity = Math.max(1, (item.quantity || 1) + delta);
        return { ...item, quantity: newQuantity };
      }
      return item;
    }));
  };

  const deleteItem = (id) => {
    if (window.confirm('¿Borrar de la lista?')) {
      setItems(items.filter(item => item.id !== id));
      if (expandedItemId === id) setExpandedItemId(null);
    }
  };

  const handleEditChange = (id, field, value) => {
    setItems(items.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  const handleTextChange = (e) => {
    const text = e.target.value;
    setNewItemText(text);

    if (text.length > 1) {
      const matches = masterList.filter(item => 
        item.name.toLowerCase().includes(text.toLowerCase())
      );
      setSuggestions(matches);
      setShowSuggestions(true);
      
      const exactMatch = masterList.find(item => item.name.toLowerCase() === text.toLowerCase());
      if (exactMatch) setSelectedCategory(exactMatch.category);
    } else {
      setShowSuggestions(false);
    }
  };

  const selectSuggestion = (suggestion) => {
    setNewItemText(suggestion.name);
    const catExists = categories[suggestion.category];
    setSelectedCategory(catExists ? suggestion.category : 'Otros');
    setShowSuggestions(false);
  };

  const addCategory = () => {
    if (!newCatName.trim()) return;
    if (categories[newCatName]) {
      alert('Ya existe una categoría con ese nombre');
      return;
    }

    const newCategoryData = {
      color: `${newCatColor.bg} ${newCatColor.text}`,
      border: newCatColor.border,
      iconName: 'Tag'
    };

    setCategories({ ...categories, [newCatName.trim()]: newCategoryData });
    setNewCatName('');
  };

  const deleteCategory = (catName) => {
    if (catName === 'Otros') {
      alert('No puedes borrar la categoría "Otros"');
      return;
    }
    if (window.confirm(`¿Borrar categoría "${catName}"? Los productos pasarán a "Otros".`)) {
      const newCats = { ...categories };
      delete newCats[catName];
      setCategories(newCats);
      setMasterList(masterList.map(item => item.category === catName ? { ...item, category: 'Otros' } : item));
      setItems(items.map(item => item.category === catName ? { ...item, category: 'Otros' } : item));
    }
  };

  const addMasterItemToCat = (catName) => {
    if (!newMasterItemText.trim()) return;
    const exists = masterList.some(item => item.name.toLowerCase() === newMasterItemText.trim().toLowerCase());
    if (exists) {
        alert('Este producto ya existe en la lista maestra.');
        return;
    }
    setMasterList([...masterList, { name: newMasterItemText.trim(), category: catName }]);
    setNewMasterItemText('');
  };

  const removeMasterItem = (itemName) => {
    if (window.confirm(`¿Borrar "${itemName}" de la lista de sugerencias?`)) {
        setMasterList(masterList.filter(item => item.name !== itemName));
    }
  };

  const onDragStart = (e, index) => {
    dragItem.current = index;
    setDraggingId(items[index].id);
    e.dataTransfer.effectAllowed = "move";
  };
  const onDragEnter = (e, index) => {
    handleReorder(index);
  };
  const onDragEnd = () => {
    dragItem.current = null;
    setDraggingId(null);
  };
  const handleTouchStart = (e, item, index) => {
    const touch = e.touches[0];
    const target = e.currentTarget.parentElement; 
    const rect = target.getBoundingClientRect();
    dragItem.current = index;
    setDraggingId(item.id);
    setDragOverlay({
      item: item,
      x: touch.clientX,
      y: touch.clientY,
      width: rect.width,
      height: rect.height,
      offsetX: touch.clientX - rect.left,
      offsetY: touch.clientY - rect.top
    });
    document.body.style.overflow = 'hidden'; 
  };
  const handleTouchMove = (e) => {
    if (!draggingId || !dragOverlay) return;
    if (e.cancelable) e.preventDefault();
    const touch = e.touches[0];
    setDragOverlay(prev => ({ ...prev, x: touch.clientX, y: touch.clientY }));
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (element) {
      const row = element.closest('[data-index]');
      if (row) {
        const targetIndex = parseInt(row.getAttribute('data-index'));
        if (!isNaN(targetIndex) && targetIndex !== dragItem.current) {
          handleReorder(targetIndex);
        }
      }
    }
  };
  const handleTouchEnd = () => {
    setDraggingId(null);
    setDragOverlay(null);
    dragItem.current = null;
    document.body.style.overflow = ''; 
  };
  const handleReorder = (targetIndex) => {
    if (dragItem.current !== null && dragItem.current !== targetIndex) {
      const newItems = [...items];
      const draggedItemContent = newItems[dragItem.current];
      const targetItemContent = newItems[targetIndex];
      if (draggedItemContent.category !== targetItemContent.category) {
         draggedItemContent.category = targetItemContent.category;
      }
      newItems.splice(dragItem.current, 1);
      newItems.splice(targetIndex, 0, draggedItemContent);
      dragItem.current = targetIndex;
      setItems(newItems);
    }
  };

  const itemsToBuy = items.filter(item => !item.completed);
  const itemsCompleted = items.filter(item => item.completed);

  const renderListWithHeaders = () => {
    if (itemsToBuy.length === 0) {
      return (
        <div className="text-center py-10 bg-white/50 rounded-3xl border border-dashed border-yellow-200 text-stone-400">
          <p className="text-lg">¡Todo listo!</p>
        </div>
      );
    }
    
    const catsToRender = [...new Set([...Object.keys(categories), 'Otros'])];

    return catsToRender.map(catName => {
      if (!categories[catName] && catName !== 'Otros') return null;

      const catItems = items.map((item, originalIndex) => ({...item, originalIndex}))
                            .filter(item => !item.completed && item.category === catName);

      if (catItems.length === 0) return null;

      const catConfig = categories[catName] || categories['Otros'] || DEFAULT_CATEGORIES['Otros'];
      const CatIcon = ICON_MAP[catConfig.iconName] || Tag;

      return (
        <div key={catName} className="mb-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
          <h2 className={`text-sm font-bold uppercase tracking-wider mb-2 px-1 flex items-center gap-2 ${catConfig.color.split(' ')[1]}`}>
            <CatIcon className="w-4 h-4" />
            {catName}
          </h2>
          <div className="space-y-2">
            {catItems.map((item) => (
              <div 
                key={item.id}
                data-index={item.originalIndex}
                draggable
                onDragStart={(e) => onDragStart(e, item.originalIndex)}
                onDragEnter={(e) => onDragEnter(e, item.originalIndex)}
                onDragEnd={onDragEnd}
                onDragOver={(e) => e.preventDefault()}
                className={`bg-white rounded-3xl shadow-sm border border-stone-100 transition-all touch-manipulation ${draggingId === item.id ? 'opacity-30 bg-stone-50' : ''}`}
              >
                <div className="flex items-center p-3 relative">
                  <div 
                    className="mr-2 text-stone-300 cursor-grab active:cursor-grabbing p-2 -ml-2 touch-none"
                    onTouchStart={(e) => handleTouchStart(e, item, item.originalIndex)}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                  >
                     <GripVertical className="w-5 h-5" />
                  </div>
                  <div onClick={() => toggleItem(item.id)} className="w-8 h-8 rounded-2xl border-2 border-stone-200 mr-3 flex-shrink-0 flex items-center justify-center cursor-pointer active:scale-90 transition-all hover:border-yellow-400 bg-stone-50"></div>
                  <div className="flex-1 min-w-0 pr-2 cursor-pointer" onClick={() => toggleItem(item.id)}>
                    <span className="text-lg font-medium text-stone-800 block truncate">{item.text}</span>
                  </div>
                  <button 
                    onClick={(e) => { e.stopPropagation(); setExpandedItemId(expandedItemId === item.id ? null : item.id); }}
                    className={`p-2 rounded-xl transition-colors mr-1 ${expandedItemId === item.id ? 'bg-yellow-100 text-yellow-700' : 'text-stone-300 hover:bg-stone-100'}`}
                  >
                    {expandedItemId === item.id ? <ChevronUp className="w-5 h-5" /> : <Edit3 className="w-5 h-5" />}
                  </button>
                  <div className="flex items-center bg-stone-50 rounded-xl p-1 border border-stone-100">
                    <button onClick={(e) => { e.stopPropagation(); updateQuantity(item.id, -1); }} className="w-7 h-7 flex items-center justify-center text-stone-400 hover:bg-white hover:text-red-500 rounded-lg transition-colors active:scale-90"><Minus className="w-4 h-4" /></button>
                    <span className="w-6 text-center font-bold text-stone-700 text-sm select-none">{item.quantity}</span>
                    <button onClick={(e) => { e.stopPropagation(); updateQuantity(item.id, 1); }} className="w-7 h-7 flex items-center justify-center text-stone-400 hover:bg-white hover:text-green-600 rounded-lg transition-colors active:scale-90"><Plus className="w-4 h-4" /></button>
                  </div>
                </div>

                {expandedItemId === item.id && (
                  <div className="border-t border-stone-100 bg-yellow-50/50 p-4 rounded-b-3xl animate-in slide-in-from-top-2 duration-200">
                    <div className="grid gap-3">
                      <div>
                        <label className="text-xs font-bold text-stone-400 uppercase ml-1">Editar Nombre</label>
                        <input type="text" value={item.text} onChange={(e) => handleEditChange(item.id, 'text', e.target.value)} className="w-full p-2 rounded-xl border border-yellow-200 focus:outline-none focus:border-yellow-400 bg-white" />
                      </div>
                      <div className="flex gap-3">
                        <div className="flex-1">
                          <label className="text-xs font-bold text-stone-400 uppercase ml-1">Mover a Pasillo</label>
                          <select value={item.category} onChange={(e) => handleEditChange(item.id, 'category', e.target.value)} className="w-full p-2 rounded-xl border border-yellow-200 focus:outline-none focus:border-yellow-400 bg-white text-sm h-10">
                            {Object.keys(categories).map(cat => (
                              <option key={cat} value={cat}>{cat}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex items-end">
                           <button onClick={() => deleteItem(item.id)} className="h-10 px-4 bg-red-100 text-red-600 rounded-xl font-bold text-sm hover:bg-red-200 flex items-center gap-2"><Trash2 className="w-4 h-4" /> Eliminar</button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    });
  };

  return (
    <div className="min-h-screen bg-yellow-50 text-stone-800 font-sans selection:bg-yellow-200 pb-32 overflow-x-hidden relative">
      <StyleTag />
      
      {/* --- SIDEBAR MENU (CONFIGURACIÓN) --- */}
      <div 
        className={`fixed inset-0 z-50 transition-all duration-300 ${isMenuOpen ? 'visible' : 'invisible'}`}
      >
        <div 
          className={`absolute inset-0 bg-stone-900/40 backdrop-blur-sm transition-opacity duration-300 ${isMenuOpen ? 'opacity-100' : 'opacity-0'}`}
          onClick={() => setIsMenuOpen(false)}
        />
        
        {/* Panel Lateral */}
        <div className={`absolute top-0 left-0 bottom-0 w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 flex flex-col ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
          
          <div className="p-6 bg-yellow-300 flex items-center justify-between">
            <h2 className="text-xl font-bold text-yellow-900 flex items-center gap-2">
              <Settings className="w-6 h-6" /> Configuración
            </h2>
            <button onClick={() => setIsMenuOpen(false)} className="p-3 bg-yellow-400/50 hover:bg-yellow-400 rounded-full text-yellow-900"><X className="w-7 h-7" /></button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-8">
            
            {/* --- SECCIÓN SEGURIDAD / DATOS --- */}
            <div className="bg-white p-5 rounded-3xl border border-stone-200 shadow-sm">
                <h3 className="font-bold text-lg text-stone-700 mb-4 flex items-center gap-2">
                    <AlertTriangle className="w-5 h-5 text-orange-500" /> Seguridad de Datos
                </h3>
                <p className="text-sm text-stone-500 mb-4 leading-relaxed">
                    Los datos viven solo en este navegador. Si borras el historial, se pierden. Haz una copia de seguridad regularmente.
                </p>
                <div className="grid grid-cols-2 gap-3">
                    <button 
                        onClick={handleExport}
                        className="flex flex-col items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-2xl border border-yellow-200 transition-colors gap-2 group"
                    >
                        <div className="p-2 bg-yellow-200 text-yellow-800 rounded-full group-hover:scale-110 transition-transform">
                            <Download className="w-6 h-6" />
                        </div>
                        <span className="text-sm font-bold text-yellow-900">Guardar Copia</span>
                    </button>

                    <button 
                        onClick={handleImportClick}
                        className="flex flex-col items-center justify-center p-4 bg-stone-50 hover:bg-stone-100 rounded-2xl border border-stone-200 transition-colors gap-2 group"
                    >
                        <div className="p-2 bg-stone-200 text-stone-600 rounded-full group-hover:scale-110 transition-transform">
                            <Upload className="w-6 h-6" />
                        </div>
                        <span className="text-sm font-bold text-stone-700">Restaurar</span>
                    </button>
                    {/* Input invisible para archivo */}
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={handleImportFile} 
                        className="hidden" 
                        accept=".json"
                    />
                </div>
            </div>

            {/* Sección: Añadir Categoría */}
            <div className="bg-yellow-50 p-5 rounded-3xl border border-yellow-200 shadow-sm">
              <h3 className="font-bold text-lg text-yellow-800 mb-4 flex items-center gap-2">
                <Plus className="w-5 h-5" /> Nueva Categoría
              </h3>
              <input 
                type="text" 
                placeholder="Nombre (ej. Bebé)" 
                value={newCatName}
                onChange={(e) => setNewCatName(e.target.value)}
                className="w-full p-3 mb-4 rounded-xl border border-yellow-200 text-base"
              />
              <div className="relative">
                <div className="flex gap-4 overflow-x-auto py-3 px-1 mb-2 no-scrollbar scroll-mask pr-6">
                  {COLOR_PRESETS.map((preset, idx) => (
                    <button 
                      key={idx}
                      onClick={() => setNewCatColor(preset)}
                      className={`w-10 h-10 rounded-full flex-shrink-0 border-2 shadow-sm ${preset.bg} ${newCatColor.name === preset.name ? 'border-stone-800 scale-110 ring-2 ring-yellow-400 ring-offset-2' : 'border-transparent'}`}
                      title={preset.name}
                    />
                  ))}
                  <div className="w-4 flex-shrink-0"></div>
                </div>
              </div>
              
              <button onClick={addCategory} disabled={!newCatName} className="w-full py-3 bg-yellow-400 text-yellow-900 font-bold rounded-2xl text-base disabled:opacity-50 mt-2 shadow-sm active:scale-95 transition-transform">Crear Categoría</button>
            </div>

            {/* Lista de Categorías */}
            <div>
              <h3 className="font-bold text-stone-400 uppercase text-sm mb-4 px-2">Categorías y Productos</h3>
              <div className="space-y-3">
                {Object.keys(categories).map(catName => {
                  const catConfig = categories[catName];
                  const CatIcon = ICON_MAP[catConfig.iconName] || Tag;
                  const isExpanded = expandedSettingsCat === catName;
                  
                  return (
                    <div key={catName} className="border border-stone-100 rounded-2xl overflow-hidden shadow-sm">
                      <div 
                        className="flex items-center justify-between p-4 bg-white hover:bg-stone-50 cursor-pointer active:bg-stone-100"
                        onClick={() => setExpandedSettingsCat(isExpanded ? null : catName)}
                      >
                        <div className="flex items-center gap-4">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${catConfig.color.split(' ')[0]} ${catConfig.color.split(' ')[1]}`}>
                            <CatIcon className="w-5 h-5" />
                          </div>
                          <span className="font-bold text-lg text-stone-700">{catName}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          {catName !== 'Otros' && (
                            <button 
                              onClick={(e) => { e.stopPropagation(); deleteCategory(catName); }}
                              className="p-3 text-stone-300 hover:text-red-500 rounded-full hover:bg-stone-100"
                            >
                              <Trash2 className="w-5 h-5" />
                            </button>
                          )}
                          {isExpanded ? <ChevronUp className="w-5 h-5 text-stone-400" /> : <ChevronDown className="w-5 h-5 text-stone-400" />}
                        </div>
                      </div>

                      {isExpanded && (
                        <div className="bg-stone-50 p-4 border-t border-stone-100">
                          <div className="flex gap-3 mb-4">
                            <input 
                              type="text" 
                              placeholder="Añadir producto..." 
                              value={newMasterItemText}
                              onChange={(e) => setNewMasterItemText(e.target.value)}
                              className="flex-1 p-3 rounded-xl border border-stone-200 text-base shadow-sm"
                            />
                            <button onClick={() => addMasterItemToCat(catName)} className="bg-stone-200 p-3 rounded-xl text-stone-600 hover:bg-stone-300 active:scale-95"><Plus className="w-6 h-6" /></button>
                          </div>
                          <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                            {masterList.filter(i => i.category === catName).map((mItem, idx) => (
                              <div key={idx} className="flex justify-between items-center bg-white p-3 rounded-xl border border-stone-100 text-base text-stone-600 shadow-sm">
                                <span className="font-medium">{mItem.name}</span>
                                <button onClick={() => removeMasterItem(mItem.name)} className="text-stone-300 hover:text-red-400 p-2"><Trash2 className="w-5 h-5" /></button>
                              </div>
                            ))}
                            {masterList.filter(i => i.category === catName).length === 0 && (
                                <p className="text-sm text-stone-400 text-center py-4 italic">Sin productos guardados</p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

          </div>
        </div>
      </div>


      {/* --- APP PRINCIPAL --- */}
      
      <header className="bg-yellow-300 py-4 px-4 shadow-sm sticky top-0 z-30 border-b border-yellow-400/30">
        <div className="max-w-md mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button 
              onClick={() => setIsMenuOpen(true)}
              className="p-2 -ml-2 hover:bg-yellow-400/50 rounded-xl transition-colors text-yellow-900"
            >
              <Menu className="w-7 h-7" />
            </button>
            <h1 className="text-xl font-bold flex items-center text-yellow-900 select-none">
              <PiggyBank className="mr-2 w-7 h-7" strokeWidth={2} />
              CasiListo
            </h1>
          </div>
          <div className="flex items-center gap-2">
            <div className="text-xs font-bold bg-yellow-100 px-3 py-1.5 rounded-full text-yellow-800 select-none">
              {itemsToBuy.length}
            </div>
            <button 
              onClick={() => { if(window.confirm('¿Empezar nueva semana?')) setItems(items.map(item => ({ ...item, completed: true }))); }}
              className="p-2 bg-white/50 rounded-full text-yellow-900 hover:bg-white active:scale-95 transition-all"
            >
              <RotateCcw className="w-5 h-5" />
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4">
        
        {/* Formulario Añadir */}
        <form onSubmit={addItem} className="mb-6 relative z-10" ref={wrapperRef}>
          <div className="relative">
            <input
              type="text"
              value={newItemText}
              onChange={handleTextChange}
              placeholder="¿Qué falta en casa?"
              className="w-full p-3 pr-14 rounded-t-3xl rounded-b-2xl border-2 border-yellow-200 bg-white shadow-sm focus:border-yellow-400 focus:ring-0 focus:outline-none text-base placeholder:text-stone-400"
            />
            {showSuggestions && suggestions.length > 0 && (
              <div className="absolute top-full left-0 right-0 bg-white border border-yellow-200 rounded-b-3xl shadow-lg mt-1 max-h-48 overflow-y-auto z-50">
                {suggestions.map((s, idx) => (
                  <div key={idx} onClick={() => selectSuggestion(s)} className="p-3 hover:bg-yellow-50 cursor-pointer flex justify-between items-center text-stone-700 border-b border-stone-50 last:border-0">
                    <span>{s.name}</span>
                    <span className="text-xs text-stone-400 bg-stone-100 px-2 py-1 rounded-full">{s.category}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
          
          <div className="flex gap-2 mt-2">
            <select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className="flex-1 p-3 rounded-2xl border border-yellow-200 bg-white text-stone-600 text-sm focus:border-yellow-400 focus:outline-none appearance-none">
              {Object.keys(categories).map(cat => <option key={cat} value={cat}>{cat}</option>)}
            </select>
            <button type="submit" disabled={!newItemText.trim()} className="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold rounded-2xl px-6 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-sm active:scale-95"><Plus className="w-6 h-6" /></button>
          </div>
        </form>

        {/* LISTAS */}
        {renderListWithHeaders()}

        {itemsCompleted.length > 0 && (
          <div className="opacity-60 hover:opacity-100 transition-opacity mt-8">
            <h2 className="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 px-2 flex items-center">En Casa / En el Carrito ({itemsCompleted.length})</h2>
            <div className="space-y-2">
              {itemsCompleted.map(item => (
                <div key={item.id} className="flex items-center justify-between p-3 bg-yellow-100/40 rounded-2xl border border-transparent select-none">
                  <div onClick={() => toggleItem(item.id)} className="flex-1 flex items-center cursor-pointer">
                    <div className="w-6 h-6 rounded-xl bg-yellow-400 border-2 border-yellow-400 mr-3 flex items-center justify-center text-white shadow-sm"><Check className="w-4 h-4" strokeWidth={3} /></div>
                    <div className="flex flex-col">
                      <span className="text-base font-medium text-stone-500 line-through decoration-stone-400 decoration-1">{item.text}</span>
                      {item.quantity > 1 && <span className="text-xs text-stone-400">Cantidad: {item.quantity}</span>}
                    </div>
                  </div>
                  <button onClick={() => deleteItem(item.id)} className="p-2 text-stone-300 hover:text-red-400"><Trash2 className="w-4 h-4" /></button>
                </div>
              ))}
            </div>
          </div>
        )}

      </main>

      {/* DRAG OVERLAY */}
      {dragOverlay && (
        <div style={{ position: 'fixed', top: dragOverlay.y - dragOverlay.offsetY, left: dragOverlay.x - dragOverlay.offsetX, width: dragOverlay.width, height: dragOverlay.height, pointerEvents: 'none', zIndex: 1000, transform: 'scale(1.02)' }} className="bg-white rounded-3xl border-2 border-yellow-400 shadow-2xl flex items-center p-3 opacity-95">
            <div className="mr-2 text-stone-300 p-2 -ml-2"><GripVertical className="w-5 h-5" /></div>
            <div className="w-8 h-8 rounded-2xl border-2 border-stone-200 mr-3 bg-stone-50"></div>
            <div className="flex-1 min-w-0 pr-2"><span className="text-lg font-bold text-stone-800 block truncate">{dragOverlay.item.text}</span></div>
            <button className="p-2 text-stone-300 mr-1"><Edit3 className="w-5 h-5" /></button>
            <div className="flex items-center bg-stone-50 rounded-xl p-1 border border-stone-100 opacity-50"><span className="w-16 text-center font-bold text-stone-700 text-sm">...</span></div>
        </div>
      )}
    </div>
  );
}